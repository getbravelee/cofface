<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.orderme.kiosk.mapper.MenuMapper">
    <!-- 메뉴 조회 결과를 Menu 객체에 매핑 -->
    <resultMap id="MenuResultMap" type="com.ssafy.orderme.kiosk.model.Menu">
        <id property="menuId" column="menu_id" />
        <result property="storeId" column="store_id" />
        <result property="menuName" column="menu_name" />
        <result property="price" column="price" />
        <result property="categoryId" column="category_id" />
        <result property="isSoldOut" column="is_sold_out" />
        <result property="imageUrl" column="image_url" />
        <result property="description" column="description" />
        <result property="isDeleted" column="is_deleted" />
        <result property="deletedAt" column="deleted_at" />
        <association property="category" javaType="com.ssafy.orderme.kiosk.model.Category">
            <result property="categoryName" column="category_name" />
        </association>
    </resultMap>

    <!-- 메뉴 옵션 조회 결과를 MenuOption 객체에 매핑 -->
    <resultMap id="MenuOptionResultMap" type="com.ssafy.orderme.kiosk.model.MenuOption">
        <id property="optionId" column="option_id" />
        <result property="menuId" column="menu_id" />
        <result property="optionCategory" column="option_category" />
        <result property="optionName" column="option_name" />
        <result property="additionalPrice" column="additional_price" />
        <result property="isDefault" column="is_default" />
        <result property="isRequired" column="is_required" />
        <result property="displayOrder" column="display_order" />
        <result property="maxSelections" column="max_selections" />
        <result property="isSoldOut" column="is_sold_out" />
        <result property="isDeleted" column="is_deleted" />
        <result property="deletedAt" column="deleted_at" />
    </resultMap>

    <!-- 매장의 모든 메뉴 조회 -->
    <select id="findAllByStoreId" parameterType="Long" resultMap="MenuResultMap">
        SELECT
            m.menu_id, m.store_id, m.menu_name, m.price, m.category_id,
            c.category_name, m.is_sold_out, m.image_url, m.description, m.is_deleted, m.deleted_at
        FROM Menus m
                 JOIN Categories c ON m.category_id = c.category_id
        WHERE m.store_id = #{storeId}
          AND m.is_deleted = FALSE
        ORDER BY c.display_order, m.menu_name
    </select>

    <!-- 카테고리별 메뉴 조회 -->
    <select id="findByCategoryId" resultMap="MenuResultMap">
        SELECT
            m.menu_id, m.store_id, m.menu_name, m.price, m.category_id,
            c.category_name, m.is_sold_out, m.image_url, m.description, m.is_deleted, m.deleted_at
        FROM Menus m
                 JOIN Categories c ON m.category_id = c.category_id
        WHERE m.store_id = #{storeId}
          AND m.category_id = #{categoryId}
          AND m.is_deleted = FALSE
        ORDER BY m.menu_name
    </select>

    <!-- 메뉴 ID로 메뉴 상세 정보 조회 -->
    <select id="findById" parameterType="Long" resultMap="MenuResultMap">
        SELECT
            m.menu_id, m.store_id, m.menu_name, m.price, m.category_id,
            c.category_name, m.is_sold_out, m.image_url, m.description, m.is_deleted, m.deleted_at
        FROM Menus m
                 LEFT JOIN Categories c ON m.category_id = c.category_id
        WHERE m.menu_id = #{menuId}
          AND m.is_deleted = FALSE
    </select>

    <!-- 메뉴 ID로 메뉴 옵션 목록 조회 -->
    <select id="findOptionsByMenuId" parameterType="Long" resultMap="MenuOptionResultMap">
        SELECT
            option_id, menu_id, option_category, option_name, additional_price,
            is_default, is_required, display_order, max_selections, is_sold_out,
            is_deleted, deleted_at
        FROM MenuOptions
        WHERE menu_id = #{menuId}
          AND is_deleted = FALSE
        ORDER BY
            option_category,
            display_order,
            option_name
    </select>

    <!-- 매장에서 가장 많이 팔린 메뉴 목록 조회 -->
    <select id="findPopularMenus" resultMap="MenuResultMap">
        SELECT
            m.menu_id, m.store_id, m.menu_name, m.price, m.category_id,
            c.category_name, m.is_sold_out, m.image_url, m.description, m.is_deleted, m.deleted_at,
            COUNT(om.order_menu_id) AS order_count
        FROM Menus m
                 JOIN OrderMenu om ON m.menu_name = om.menu_name
                 JOIN Orders o ON om.order_id = o.order_id
                 LEFT JOIN Categories c ON m.category_id = c.category_id
        WHERE o.store_id = #{storeId}
          AND m.is_deleted = false
          AND o.is_deleted = false
        GROUP BY m.menu_id, m.store_id, m.menu_name, m.price, m.category_id,
                 c.category_name, m.is_sold_out, m.image_url, m.description, m.is_deleted, m.deleted_at
        ORDER BY order_count DESC
            LIMIT #{limit}
    </select>

    <!-- 사용자가 가장 많이 주문한 메뉴 목록 조회(수정) -->
    <select id="findFrequentOrderedMenus" resultMap="MenuResultMap">
        SELECT
            m.menu_id, m.store_id, m.menu_name, m.price, m.category_id,
            c.category_name, m.is_sold_out, m.image_url, m.description, m.is_deleted, m.deleted_at,
            COUNT(DISTINCT om.order_id) AS order_count
        FROM OrderMenu om
                 JOIN Orders o ON om.order_id = o.order_id
                 JOIN Users u ON o.internal_id = u.internal_id
                 JOIN Menus m ON om.menu_name = m.menu_name AND m.store_id = o.store_id
                 LEFT JOIN Categories c ON m.category_id = c.category_id
        WHERE o.store_id = #{storeId}
          AND u.user_id = #{userId}
          AND m.is_deleted = false
          AND o.is_deleted = false
        GROUP BY m.menu_id
        ORDER BY order_count DESC
            LIMIT #{limit}
    </select>
</mapper>